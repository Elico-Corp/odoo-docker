#!/bin/bash
#
# This script is designed to be run inside the container
#

# fail hard and fast even on pipelines
set -eo pipefail

log_src='['${0##*/}']'

function help {
    set +e
    cat bin/help.txt
    set -e
}

function login  {
    echo $log_src[`date +%F.%H:%M:%S`]' Running bash'
    set +e
    if [[ ! -e $1 && $1 = "root" ]]; then
        /bin/bash
    else
        sudo su - odoo
    fi
    SERVICE_PID=$!
    set -e
}

function start {
    echo $log_src[`date +%F.%H:%M:%S`]' Updating Odoo conf...'
    if [ "$ADMIN_PASSWORD" ]; then
        sudo -i -u odoo sed -i "s/_ADMIN_PASSWORD_/$ADMIN_PASSWORD/g" /opt/odoo/etc/odoo.conf
    fi

    if [ "$DB_USER" ]; then
        sudo -i -u odoo sed -i "s/_DB_USER_/$DB_USER/g" /opt/odoo/etc/odoo.conf
    fi

    if [ "$DB_PASSWORD" ]; then
        sudo -i -u odoo sed -i "s/_DB_PASSWORD_/$DB_PASSWORD/g" /opt/odoo/etc/odoo.conf
    fi

    if [ "$DB_FILTER" ]; then
        sudo -i -u odoo sed -i "s/_DB_FILTER_/$DB_FILTER/g" /opt/odoo/etc/odoo.conf
    fi

    if [ "$ADDONS_REPO" ]; then
        echo $log_src[`date +%F.%H:%M:%S`]' Setting up SSH key'
        cp -R /mnt/ssh /opt/odoo/.ssh
        ssh-keyscan github.com >> /opt/odoo/.ssh/known_hosts
        chown -R odoo:odoo /opt/odoo/.ssh
        chmod 600 /opt/odoo/.ssh/*
        echo $log_src[`date +%F.%H:%M:%S`]' Downloading additional addons...'
        sudo -i -u odoo python /opt/odoo/auto_addons/addons.py $ADDONS_REPO $FETCH_OCA_DEPENDENCIES
    else
        echo $log_src[`date +%F.%H:%M:%S`]' No additional addons to download'
        # FIXME this script should be replaced with the code from commit 6076053
        sudo -i -u odoo python /opt/odoo/auto_addons/no_addons.py
    fi

    echo $log_src[`date +%F.%H:%M:%S`]' Checking special requirements...'
    bash /mnt/scripts/startup.sh

    echo $log_src[`date +%F.%H:%M:%S`]' Running odoo...'
    set +e
    if [ ! -e $1 ]; then
        echo $log_src[`date +%F.%H:%M:%S`]' ...with additional args: $*'
    fi
    sudo -i -u odoo /usr/bin/python \
                    /opt/odoo/sources/odoo/odoo-bin \
                    -c $file \
                    $*

    SERVICE_PID=$!
    set -e
}

# smart shutdown on SIGINT and SIGTERM
function on_exit() {
    kill -TERM $SERVICE_PID
    wait $SERVICE_PID 2>/dev/null
    exit 0
}
trap on_exit INT TERM

echo $log_src[`date +%F.%H:%M:%S`]' Search conf file'
if [[ -z "$ODOO_CONF" ]];
then
    file="/opt/odoo/etc/odoo.conf"
else
    file=$ODOO_CONF
fi
echo $log_src[`date +%F.%H:%M:%S`]' Running command...'
for arg in "$*"
do
    $arg
done

wait
